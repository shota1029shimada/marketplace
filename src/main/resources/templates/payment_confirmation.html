<script th:inline="javascript">
  // サーバから受け取った Stripe 公開キー（文字列なのでクオート付きで埋め込む）
  const stripePublicKey = /*[[${stripePublicKey}]]*/ "";
  // サーバサイドで作成された PaymentIntent のクライアントシークレット（文字列）
  const clientSecret = /*[[${clientSecret}]]*/ "";
  // 遷移元の商品 ID（数値想定。文字列なら "" にしてもOK）
  const itemId = /*[[${itemId}]]*/ 0;

  // Stripe を公開キーで初期化
  const stripe = Stripe(stripePublicKey);

  // Elements をクライアントシークレット付きで生成
  const elements = stripe.elements({ clientSecret });

  // 決済 UI 要素（支払いフォーム）を作成してマウント
  const paymentElement = elements.create("payment");
  paymentElement.mount("#payment-element");

  // 決済確定ボタン
  const submitButton = document.getElementById("submit");
  // エラーメッセージ表示領域
  const messageContainer = document.getElementById("payment-message");

  submitButton.addEventListener("click", async (e) => {
    e.preventDefault();

    // PaymentIntent ID を clientSecret から安全に抽出
    // clientSecret例: "pi_12345_secret_abcdef" → "pi_12345"
    const paymentIntentId = clientSecret.split("_secret")[0];

    const { error } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url:
          window.location.origin +
          "/orders/complete-purchase?paymentIntentId=" +
          paymentIntentId,
      },
      redirect: "if_required",
    });

    if (error) {
      // カードエラー or 入力検証エラー
      if (error.type === "card_error" || error.type === "validation_error") {
        messageContainer.textContent = error.message;
      } else {
        messageContainer.textContent = "予期せぬエラーが発生しました。";
      }
      return;
    }

    // redirect が不要で成功した場合はここに来る（サーバ検証のため完了URLへ遷移）
    window.location.href =
      "/orders/complete-purchase?paymentIntentId=" + paymentIntentId;
  });
</script>
