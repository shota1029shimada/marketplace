<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>決済確認 - フリマアプリ</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<!-- Stripe.js ライブラリを読み込み -->
	<script src="https://js.stripe.com/v3/"></script>
</head>

<body>
	<div class="container">
		<h1>決済確認</h1>
		
		<!-- テストモード案内（開発環境用） -->
		<div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
			<p style="margin: 0 0 10px 0;"><strong>⚠️ テストモード</strong></p>
			<p style="margin: 0 0 10px 0;">現在はテストモードです。実際のクレジットカード情報は使用できません。</p>
			<p style="margin: 0;"><strong>テスト用カード番号:</strong></p>
			<ul style="margin: 5px 0 0 20px; padding: 0;">
				<li><strong>成功:</strong> 4242 4242 4242 4242</li>
				<li><strong>拒否:</strong> 4000 0000 0000 0002</li>
				<li><strong>3Dセキュア認証:</strong> 4000 0025 0000 3155</li>
			</ul>
			<p style="margin: 10px 0 0 0; font-size: 0.9em;">有効期限: 任意の未来の日付（例: 12/34）、CVC: 任意の3桁（例: 123）、郵便番号: 任意</p>
		</div>
		
		<!-- エラーメッセージ表示領域 -->
		<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
		
		<!-- 必要な情報がない場合のメッセージ -->
		<div th:if="${clientSecret == null or clientSecret.isEmpty() or itemId == null}" class="error-message">
			<p>決済情報が正しく取得できませんでした。商品詳細ページから再度購入ボタンを押してください。</p>
			<a th:href="@{/items}" class="button">商品一覧へ戻る</a>
		</div>
		
		<!-- 決済フォーム -->
		<div id="payment-form" th:if="${clientSecret != null and !clientSecret.isEmpty() and itemId != null}">
			<!-- Stripe Elements がマウントされる領域 -->
			<div id="payment-element">
				<!-- Stripe Elements がここに決済フォームを表示します -->
			</div>
			
			<!-- 決済確定ボタン -->
			<button id="submit" class="button" style="margin-top: 20px;">
				<span id="button-text">決済を確定する</span>
			</button>
			
			<!-- エラーメッセージ表示領域 -->
			<div id="payment-message" class="error-message" style="margin-top: 15px;"></div>
		</div>
		
		<!-- 戻るボタン -->
		<div class="button-group" style="margin-top: 30px;">
			<a th:href="@{/items/{id}(id=${itemId})}" class="button secondary">商品詳細に戻る</a>
			<a th:href="@{/items}" class="button secondary">商品一覧へ</a>
		</div>
	</div>

	<script th:inline="javascript">
		// サーバから受け取った Stripe 公開キー（文字列なのでクオート付きで埋め込む）
		const stripePublicKey = /*[[${stripePublicKey}]]*/ "";
		// サーバサイドで作成された PaymentIntent のクライアントシークレット（文字列）
		const clientSecret = /*[[${clientSecret}]]*/ "";
		// 遷移元の商品 ID（数値想定。文字列なら "" にしてもOK）
		const itemId = /*[[${itemId}]]*/ 0;

		// 必要な情報が揃っているかチェック
		if (!stripePublicKey || !clientSecret) {
			document.getElementById("payment-message").textContent = "決済情報の読み込みに失敗しました。もう一度お試しください。";
			document.getElementById("payment-form").style.display = "none";
		} else {
			// Stripe を公開キーで初期化
			const stripe = Stripe(stripePublicKey);

			// Elements をクライアントシークレット付きで生成
			const elements = stripe.elements({ clientSecret });

			// 決済 UI 要素（支払いフォーム）を作成してマウント
			const paymentElement = elements.create("payment");
			paymentElement.mount("#payment-element");

			// 決済確定ボタン
			const submitButton = document.getElementById("submit");
			// エラーメッセージ表示領域
			const messageContainer = document.getElementById("payment-message");
			// ボタンテキスト
			const buttonText = document.getElementById("button-text");

			submitButton.addEventListener("click", async (e) => {
				e.preventDefault();
				
				// エラーメッセージをクリア
				messageContainer.textContent = "";
				messageContainer.style.display = "none";
				
				// ボタンを無効化してローディング状態に
				submitButton.disabled = true;
				buttonText.textContent = "処理中...";
				submitButton.style.opacity = "0.6";
				submitButton.style.cursor = "not-allowed";

				// PaymentIntent ID を clientSecret から安全に抽出
				// clientSecret例: "pi_12345_secret_abcdef" → "pi_12345"
				const paymentIntentId = clientSecret.split("_secret")[0];

				try {
					const { error, paymentIntent } = await stripe.confirmPayment({
						elements,
						confirmParams: {
							return_url:
								window.location.origin +
								"/orders/complete-purchase?paymentIntentId=" +
								paymentIntentId,
						},
						redirect: "if_required",
					});

					if (error) {
						// ボタンを再度有効化
						submitButton.disabled = false;
						buttonText.textContent = "決済を確定する";
						submitButton.style.opacity = "1";
						submitButton.style.cursor = "pointer";
						
						// エラーメッセージを表示
						let errorMessage = error.message || "予期せぬエラーが発生しました。";
						
						// カードエラー or 入力検証エラー
						if (error.type === "card_error" || error.type === "validation_error") {
							// テストモードでの実際のカード番号使用を検出した場合の案内
							if (error.code === "card_declined" || error.message.includes("declined") || error.message.includes("拒否")) {
								errorMessage = error.message + "\n\n※ テストモードでは実際のクレジットカード番号は使用できません。上記のテスト用カード番号（4242 4242 4242 4242）をご使用ください。";
							}
							messageContainer.textContent = errorMessage;
							messageContainer.style.whiteSpace = "pre-line"; // 改行を有効にする
							messageContainer.style.display = "block";
						} else {
							messageContainer.textContent = errorMessage;
							messageContainer.style.display = "block";
						}
						
						// エラーメッセージをスクロールして見えるようにする
						messageContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });
						return;
					}

					// 成功時の処理
					if (paymentIntent && paymentIntent.status === "succeeded") {
						// 成功メッセージを表示
						buttonText.textContent = "決済が完了しました！リダイレクト中...";
						
						// サーバ検証のため完了URLへ遷移
						setTimeout(() => {
							window.location.href =
								"/orders/complete-purchase?paymentIntentId=" + paymentIntentId;
						}, 500);
					} else {
						// redirect が不要で成功した場合はここに来る（サーバ検証のため完了URLへ遷移）
						window.location.href =
							"/orders/complete-purchase?paymentIntentId=" + paymentIntentId;
					}
				} catch (err) {
					// 予期しないエラー
					submitButton.disabled = false;
					buttonText.textContent = "決済を確定する";
					submitButton.style.opacity = "1";
					submitButton.style.cursor = "pointer";
					messageContainer.textContent = "予期せぬエラーが発生しました: " + (err.message || "不明なエラー");
					messageContainer.style.display = "block";
					messageContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });
				}
			});
		}
	</script>
</body>
</html>
